<!doctype html>
<html lang="fr">
<head>
  <meta http-equiv="Content-Security-Policy"
  content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com;
    connect-src 'self' https://zcvonimwydisajxqjcec.supabase.co https://*.supabase.co;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src https://fonts.gstatic.com;
    img-src 'self' data:;
  ">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BORDE TA VOILE â€” Gestion des entreprises</title>

  <link rel="stylesheet" href="./src/styles/main.css" />

  <!-- React + ReactDOM + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://zcvonimywdisajxgjcec.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpjdm9uaW15d2Rpc2FqeGdqY2VjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NzY4MTMsImV4cCI6MjA3OTA1MjgxM30.0PqY59iyVI7-oaj1xVPKky66744O8zw804QhUddnR38";

    // Client global utilisable dans GestionUI.jsx
    window.supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>
</head>

<body>
  <!-- Bandeau -->
  <header class="header-bar">
    <div class="brand">
      <img class="brand-logo" src="./build/logo.png" alt="BORDE TA VOILE" />
      <div class="brand-text">
        <div class="brand-title">BORDE TA VOILE</div>
        <div class="brand-sub">Gestion des entreprises</div>
      </div>
    </div>

    <!-- Indicateurs (date/heure / nombre / relances / sauvegarde) -->
    <nav class="header-indicators">
      <span class="chip info" id="indDate">â€”</span>
      <span class="chip info" id="indCount">â€”</span>
      <span class="chip info" id="indRelances">ğŸ”” 0</span>
      <span class="chip info" id="indSaved">â˜ï¸ SauvegardÃ©</span>
    </nav>

    <!-- Actions regroupÃ©es -->
    <nav class="header-actions">
      <div class="dropdown" id="menuData">
        <button class="chip" id="btnMenuData">ğŸ“‚ DonnÃ©es â–¾</button>
        <div class="dropdown-panel">
          <button class="dd-item" id="btnImport">ï¼‹ Importer (CSV)</button>
          <button class="dd-item" id="btnExport">â¤´ Exporter (CSV)</button>
          <button class="dd-item" id="btnPrintMail">ğŸ–¨ï¸ Imprimer le courrier</button>
          <button class="dd-item" id="btnLabel">ğŸ·ï¸ Imprimer lâ€™Ã©tiquette</button>
          <button class="dd-item" id="btnCSVModel">â¬‡ï¸ TÃ©lÃ©charger modÃ¨le CSV</button>
          <button class="dd-item" id="btnMergeDup">ğŸ”€ Fusionner les doublons</button>
          <button class="dd-item" id="btnClearAll">ğŸ—‘ï¸ Vider la base</button>
        </div>
      </div>

      <button class="chip" id="btnSearchNew">ğŸ” Recherche nouvelle entreprise</button>
      <button class="chip" id="btnAICourrier">ğŸª„ IA Courrier</button>
      <button class="chip primary" id="btnAI">ğŸ” IA Recherche</button>
    </nav>
  </header>

  <!-- âš ï¸ CIBLE REACT -->
  <div id="app"></div>

  <!-- Modale IA Recherche -->
  <div id="aiModal" class="modal-backdrop" style="display:none" onclick="this.style.display='none'">
    <div class="modal" onclick="event.stopPropagation()">
      <h3>Demande IA</h3>
      <textarea id="aiPrompt" class="textarea-lg" rows="10"></textarea>
      <div class="modal-actions centered">
        <button class="btn" id="btnAICopy">ğŸ“‹ Copier</button>
        <button class="btn" onclick="document.getElementById('aiModal').style.display='none'">Fermer</button>
      </div>
    </div>
  </div>

  <!-- Modale : Recherche nouvelle entreprise (remplace les prompt()) -->
<div id="searchModal" class="modal-backdrop" style="display:none" onclick="this.style.display='none'">
  <form id="searchForm" class="modal solid" onclick="event.stopPropagation();">
    <h3>Recherche nouvelle entreprise</h3>

    <div class="modal-grid">
      <div>
        <label>Nombre d'entreprises</label>
        <input type="number" id="snCount" min="1" step="1" value="20" />
      </div>

      <div>
        <label>Rayon autour du siÃ¨ge (km)</label>
        <input type="number" id="snRadius" min="1" step="1" value="25" />
      </div>

      <div>
        <label>Tailles visÃ©es</label>
        <div class="modal-row">
          <label class="square-check"><input type="checkbox" class="snSize" value="MIC" checked /> MIC (â‰¤9)</label>
          <label class="square-check"><input type="checkbox" class="snSize" value="PET" checked /> PET (10â€“49)</label>
        </div>
        <div class="modal-row">
          <label class="square-check"><input type="checkbox" class="snSize" value="MOY" checked /> MOY (50â€“249)</label>
          <label class="square-check"><input type="checkbox" class="snSize" value="GDE" checked /> GDE (â‰¥250)</label>
        </div>
      </div>

      <div>
        <label>Adresse du siÃ¨ge</label>
        <input id="snHQ" value="Locquirec 29620" />
      </div>
    </div>

    <div class="modal-row" style="margin-top:8px">
      <label class="square-check">
        <input type="checkbox" id="snIncludeModel" checked />
        <span>Inclure le <b>modÃ¨le CSV</b> dans le prompt</span>
      </label>
      <small class="modal-context">Tu devras aussi <u>joindre le fichier</u> dans ChatGPT (icÃ´ne ğŸ“) pour quâ€™il sâ€™y rÃ©fÃ¨re.</small>
    </div>

    <div class="modal-actions centered">
      <button type="button" class="btn" id="snCancel">Annuler</button>
      <button type="submit" class="btn cta" id="snGo">GÃ©nÃ©rer le prompt</button>
    </div>
  </form>
</div>


  <!-- Logger visible en cas d'erreur de montage -->
  <div id="bootlog" style="position:fixed;left:8px;bottom:8px;z-index:9999;font:12px/1.3 system-ui;background:rgba(0,0,0,.7);color:#fff;padding:8px 10px;border-radius:8px;max-width:60ch;display:none"></div>

  <!-- Scripts de l'app (l'ordre compte) -->
  <script type="text/babel" data-presets="env,react" src="./src/components/GestionUI.jsx"></script>
  <script src="./src/utils/dataManager.js"></script>
  <script src="./renderer.js"></script>

  <!-- Bootlog errors -->
  <script>
    (function(){
      const box = document.getElementById('bootlog');
      const show = (msg)=>{ box.style.display='block'; box.textContent = msg; console.error('[BOOTLOG]', msg); };
      window.addEventListener('error', (e)=> show(String(e.message||e.error||'Erreur JS')));
      window.addEventListener('unhandledrejection', (e)=> show('Promise rejetÃ©e: ' + (e.reason?.message || String(e.reason))));
      window.addEventListener('btv:ui-mounted', ()=> { box.style.display='none'; });
    })();
  </script>
</body>
</html>
